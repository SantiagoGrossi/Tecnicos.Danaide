@model Inspinia_MVC5_SeedProject.ViewModels.PermisosUsuariosViewModel
@{
    ViewBag.Title = "Administración de usuarios";
}

<div class"" id="listaUsuarios">
   
</div>

<div class="container">
    <div class="row">
        <div class="col-lg-6">
            <div class="form-group" style="padding-top:3%">

                
                    @*@Html.LabelFor(m => m.Issue.AreaTecnicos)*@
                    @Html.DropDownListFor(m => m.Usuario.Nombre, new SelectList(Model.ApplicationUsers, "Id", "Nombre"),"Seleccionar usuario", new { @class = "form-control area",@id ="userName" })
                    @Html.ValidationMessageFor(m => m.Usuario.Id)
                
            </div>
        </div>
    </div>
    <div class="row" id="selectPermisosUsuario">
        <div class="col-lg-6">
            <div class="form-group" style="padding-top:3%" id="divSelectClientes">


                <label for="selectClientesLabel">Clientes:</label>
                <select multiple class="form-control" id="selectClientes">
                    

                </select>

            </div>
        </div>

        <div class="col-lg-6">
            <div class="form-group" style="padding-top:3%" id="divSelectAreas">


                <label for="selectAreas">Areas:</label>
                <select multiple class="form-control" id="selectAreas">
                   

                </select>

            </div>
        </div>
    </div>
    <button type="submit" class="btn btn-primary" id="guardarPermisos">Guardar permisos</button>

</div>

@section scripts{
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        $(document).ready(function () {

            $("#userName").change(function () {

                function traerAreasDeUsuario() {
                    $.ajax({
                        type: "GET",
                        url: "/Admin/traerAreas/" + $("#userName").val(),
                        success: function (data) {

                            $('#selectAreas').remove();
                            $('#divSelectAreas').append('<select multiple class="form-control" id="selectAreas"></select>');


                            $.each(data.Areas, function (key,value) {
                                $("#selectAreas").append('<option value=' + value.Id + '>' + value.Nombre + '</option>')
                            });
                            

                        },
                        error: function (error) {
                            alert = "Algo salió mal, avisale a Santiago :("
                        }
                    })
                }

                function traerClientesDeUsuario() {
                    $.ajax({
                        type: "GET",
                        url: "/Admin/traerClientes/" + $("#userName").val(),
                        success: function (data) {
                        
                            $('#selectClientes').remove();
                            $('#divSelectClientes').append('<select multiple class="form-control" id="selectClientes"></select>');


                            $.each(data.Clientes, function (key, value) {
                                $("#selectClientes").append('<option value='+value.Id+'>' + value.Nombre + '</option>')
                            });


                        },
                        error: function (error) {
                            alert = "Algo salió mal, avisale a Santiago :("
                        }
                    })
                }

                traerAreasDeUsuario();
                traerClientesDeUsuario();




            });

            $("#guardarPermisos").click(function () {
                var dto = new Object();
                dto.ListaAreas =$("#selectAreas").val();
                dto.UserId = $("#userName").val()
                dto.ListaClientes = $("#selectClientes").val();

                $.ajax({
                    url: "/Admin/ModificarUsuario",
                    type: "Post",
                    contentType: "application/json",
                    dataType: "JSON",
                   


                    data: JSON.stringify(dto),
                        
                        
                       
                        


                    




                })
                                     .done(function () {
                                         toastr.success("Usuario modificado :)");
                                         
                                         //window.location.href = "/issues/IndexIssues";
                                         //validator.resetForm();
                                     })
                                    .fail(function () {
                                        toastr.error("Algo falló, enviale captura de pantalla a Santiago por favor.");

                                    })
            });
        });
    </script>
}